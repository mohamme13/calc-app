<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>حاسبة المعدل — سريع</title>
  <style>
    :root{--main:#2481cc;--bg:#f6f8fb;--accent:#27ae60;--err:#e74c3c}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:16px;display:flex;justify-content:center}
    .card{width:100%;max-width:720px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 12px;color:var(--main);text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-weight:600;margin-bottom:6px;display:block}
    input,select,button{font-size:15px;padding:10px;border-radius:8px;border:1px solid #dcdcdc;outline:none;background:#fff}
    input[type=number]{width:120px}
    .btn{background:var(--main);color:#fff;border:none;cursor:pointer}
    .btn.secondary{background:#7f8c8d}
    .hidden{display:none!important}
    .sub-list{margin-top:14px;display:grid;gap:12px}
    .sub-card{padding:12px;border:1px solid #eef0f4;border-radius:10px;position:relative;background:#fcfeff}
    .badge{position:absolute;left:12px;top:10px;background:#eaf5ff;color:var(--main);padding:4px 8px;border-radius:6px;font-size:12px}
    small{color:#666}
    #result{margin-top:16px;text-align:center;font-weight:700;color:var(--accent)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .file{display:inline-block}
    .loader{width:28px;height:28px;border-radius:50%;border:3px solid #eee;border-top-color:var(--main);animation:rot 1s linear infinite;display:inline-block}
    @keyframes rot{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eef0f4;padding:8px;text-align:center}
    .small{font-size:13px;color:#555}
  </style>
</head>
<body>
  <div class="card" id="app">
    <h1>حاسبة المعدل السريعة</h1>

    <div id="overlay-check" style="text-align:center;margin-bottom:12px">
      <div class="loader" id="loader"></div>
      <div class="small" style="margin-top:8px">جارٍ التحقق من الاشتراك...</div>
      <div class="small" id="check-msg" style="margin-top:8px;color:#b04">إذا استمر التحميل طويلاً، اضغط تحقق مرة أخرى</div>
      <div style="margin-top:8px">
        <button class="btn secondary" id="retry-btn">تحقق مجدداً</button>
      </div>
    </div>

    <div id="main-ui" class="hidden">
      <div class="row" style="align-items:end">
        <div style="flex:1">
          <label>اسم التخصص</label>
          <input id="spec-name" placeholder="مثلاً: هندسة" />
        </div>
        <div>
          <label>عدد المواد</label>
          <input id="total-sub" type="number" min="1" step="1" value="6" />
        </div>
        <div style="min-width:120px">
          <label>&nbsp;</label>
          <button id="start-btn" class="btn">ابدأ</button>
        </div>
      </div>

      <div id="setup-area" class="hidden" style="margin-top:12px">
        <div class="small">أضف المواد يدويًا أو استورد من CSV ثم اضغط "توليد واجهة الدرجات"</div>
        <div style="margin-top:10px" class="row">
          <input id="sub-name" placeholder="اسم المادة" style="flex:1" />
          <input id="sub-coeff" type="number" value="1" min="0.25" step="0.25" style="width:120px" />
          <select id="sub-type" style="width:200px">
            <option value="ex">امتحان (EX)</option>
            <option value="both">EX + TD</option>
            <option value="all">EX + TD + TP</option>
          </select>
          <button id="add-sub" class="btn">أضف</button>
        </div>

        <div class="controls" style="margin-top:10px">
          <button id="gen-grading" class="btn">توليد واجهة الدرجات</button>
          <button id="import-csv" class="btn secondary">استيراد CSV</button>
          <input id="file-input" type="file" accept=".csv" class="file hidden" />
          <button id="clear-config" class="btn secondary">مسح التخزين</button>
        </div>

        <div class="sub-list" id="sub-list"></div>
      </div>

      <div id="grading-area" class="hidden">
        <h3 class="small" id="spec-title">التخصص</h3>
        <div id="grades-container"></div>

        <div class="controls" style="margin-top:12px">
          <button id="calc-btn" class="btn">حساب المعدل</button>
          <button id="export-csv" class="btn secondary">تصدير CSV</button>
          <button id="download-pdf" class="btn">تنزيل PDF</button>
        </div>

        <div id="result" class="hidden"></div>

        <div id="table-result" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- templates -->
  <template id="sub-template">
    <div class="sub-card">
      <span class="badge"></span>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <div class="small name"></div>
        </div>
        <div style="width:110px;text-align:center"><small>معامل</small><div class="coeff"></div></div>
        <div style="width:140px;text-align:center"><small>نوع</small><div class="type"></div></div>
        <div style="width:80px;text-align:center">
          <button class="btn secondary remove-sub">حذف</button>
        </div>
      </div>
    </div>
  </template>

  <template id="grade-row-template">
    <div class="sub-card grade-row">
      <span class="badge type-badge"></span>
      <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center">
        <div><strong class="g-name"></strong><div class="small">المعامل: <span class="g-coeff"></span></div></div>
        <div class="inputs" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="text-align:center"><div class="small">المعدل</div><div class="g-avg">0.00</div></div>
      </div>
    </div>
  </template>

  <!-- html2pdf (خيار تنزيل PDF بسرعة) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ===== إعدادات الأداء والتحقق (inline worker + timeout + cache) ===== */
const CHECK_URL = 'https://check-sub.nbvcxnbvcx41.workers.dev'; // عدّل إلى endpoint الذي تستخدمه
const CACHE_KEY = 'fast_gpa_sub_v1';
const CACHE_TTL = 2 * 60 * 60 * 1000; // ساعتان
const WORKER_TIMEOUT = 3200; // ms
const FALLBACK_TIMEOUT = 3500; // ms

let tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
let app = { specName: '', subjects: [] };
const STORAGE_KEY = 'fast_gpa_config_v1';

/* ===== Inline worker source (بسيط وخفيف جدًا) ===== */
const inlineWorkerSource = `
self.onmessage = async (e) => {
  const data = e.data || {};
  if (data.cmd !== 'check') return self.postMessage({ ok:false, error:'unknown-cmd' });
  const userId = data.userId;
  const url = data.url;
  if (!userId) return self.postMessage({ ok:false, error:'no-user' });

  const fetchWithTimeout = (u, ms = 3000) => {
    const c = new AbortController();
    const tid = setTimeout(()=>c.abort(), ms);
    return fetch(u, { signal: c.signal }).finally(()=>clearTimeout(tid));
  };

  try {
    const res = await fetchWithTimeout(url + '?userId=' + encodeURIComponent(userId), 3000);
    if (!res.ok) return self.postMessage({ ok:false, error:'bad-status', status: res.status });
    const json = await res.json();
    self.postMessage({ ok:true, ...json });
  } catch (err) {
    const isAbort = err && err.name === 'AbortError';
    self.postMessage({ ok:false, error: isAbort ? 'timeout' : (err && err.message ? err.message : 'fetch-error') });
  }
};
`;

/* ===== إنشاء العامل inline (Blob) ===== */
function createInlineWorker(srcText) {
  const blob = new Blob([srcText], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  const worker = new Worker(url);
  // revokeObjectURL بعد إنشاء العامل لتقليل التسرب المحتمل
  URL.revokeObjectURL(url);
  return worker;
}

/* ===== تحقق الاشتراك مع محاولات fallback وسرعة استجابة ===== */
async function checkSubscriptionFast() {
  // تحقق من الكاش أولاً
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    try {
      const parsed = JSON.parse(cached);
      if (Date.now() - parsed.ts < CACHE_TTL) return parsed.value;
    } catch(e){}
  }

  // userId من Telegram إذا متوفر
  const userId = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id : null;

  // إنشئ العامل inline
  let worker;
  try { worker = createInlineWorker(inlineWorkerSource); } catch(e){ worker = null; }

  // انتظار رد العامل مع timeout
  const workerPromise = new Promise((resolve) => {
    if (!worker) return resolve(null);
    const timer = setTimeout(() => {
      try { worker.terminate(); } catch(e){}
      resolve(null);
    }, WORKER_TIMEOUT);
    worker.onmessage = (ev) => {
      clearTimeout(timer);
      resolve(ev.data);
      try { worker.terminate(); } catch(e){}
    };
    worker.postMessage({ cmd: 'check', userId, url: CHECK_URL });
  });

  const workerResult = await workerPromise;

  if (workerResult === null) {
    // fallback: طلب fetch مباشر مع timeout
    try {
      const ac = new AbortController();
      const tid = setTimeout(()=>ac.abort(), FALLBACK_TIMEOUT);
      const res = await fetch(`${CHECK_URL}?userId=${encodeURIComponent(userId)}`, { signal: ac.signal });
      clearTimeout(tid);
      if (!res.ok) throw new Error('bad-status:'+res.status);
      const json = await res.json();
      localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), value: json }));
      return json;
    } catch (err) {
      return { ok: false, error: err.name === 'AbortError' ? 'timeout' : (err.message || 'fetch-error') };
    }
  } else {
    // خزن وارجع
    try { localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), value: workerResult })); } catch(e){}
    return workerResult;
  }
}

/* ===== واجهة المستخدم: حفظ/تحميل الإعدادات والوظائف ===== */
function saveConfig() { localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function loadConfig() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { app = JSON.parse(raw); } catch(e){}
  }
}

/* ===== عناصر وإدارة المواد ===== */
const subListEl = document.getElementById('sub-list');
const subTpl = document.getElementById('sub-template');
const gradeTpl = document.getElementById('grade-row-template');

function renderSubList() {
  subListEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  app.subjects.forEach((s, idx) => {
    const node = subTpl.content.cloneNode(true);
    node.querySelector('.name').innerText = s.name;
    node.querySelector('.coeff').innerText = s.coeff;
    node.querySelector('.type').innerText = (s.type || 'ex').toUpperCase();
    node.querySelector('.badge').innerText = (idx+1);
    const removeBtn = node.querySelector('.remove-sub');
    removeBtn.addEventListener('click', ()=> {
      app.subjects.splice(idx,1);
      saveConfig(); renderSubList();
    });
    frag.appendChild(node);
  });
  subListEl.appendChild(frag);
}

document.getElementById('add-sub').addEventListener('click', () => {
  const name = document.getElementById('sub-name').value.trim();
  const coeff = parseFloat(document.getElementById('sub-coeff').value) || 1;
  const type = document.getElementById('sub-type').value;
  if (!name) return alert('أدخل اسم المادة');
  app.subjects.push({ name, coeff, type, ratio: 0.6 });
  document.getElementById('sub-name').value = '';
  saveConfig(); renderSubList();
});

document.getElementById('start-btn').addEventListener('click', () => {
  const total = parseInt(document.getElementById('total-sub').value) || 0;
  if (total <= 0) return alert('أدخل عدد مواد صحيح');
  document.getElementById('setup-area').classList.remove('hidden');
  if (!app.subjects || app.subjects.length === 0) {
    for (let i=0;i<Math.min(total,20);i++) app.subjects.push({ name: `مادة ${i+1}`, coeff:1, type:'ex', ratio:0.6 });
    saveConfig(); renderSubList();
  }
});

/* ===== استيراد CSV بسيط ===== */
document.getElementById('import-csv').addEventListener('click', ()=> document.getElementById('file-input').click());
document.getElementById('file-input').addEventListener('change', (e) => {
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    parseCSV(ev.target.result);
    saveConfig(); renderSubList();
  };
  reader.readAsText(f,'utf-8');
});
function parseCSV(text) {
  // يتوقع: name,coeff,type
  const lines = text.split(/\\r?\\n/).map(l => l.trim()).filter(Boolean);
  app.subjects = [];
  for (const ln of lines) {
    const parts = ln.split(',');
    if (parts.length>=1) {
      const name = parts[0].trim();
      const coeff = parseFloat(parts[1]) || 1;
      const type = (parts[2]||'ex').trim();
      app.subjects.push({ name, coeff, type, ratio:0.6 });
    }
  }
}

/* ===== توليد واجهة الدرجات بسرعة باستخدام templates ===== */
document.getElementById('gen-grading').addEventListener('click', () => {
  renderGrading();
});

function renderGrading() {
  document.getElementById('grades-container').innerHTML = '';
  document.getElementById('spec-title').innerText = (document.getElementById('spec-name').value || app.specName || 'تخصص');
  app.specName = document.getElementById('spec-name').value || app.specName;
  saveConfig();

  const frag = document.createDocumentFragment();
  app.subjects.forEach((s, i) => {
    const node = gradeTpl.content.cloneNode(true);
    node.querySelector('.g-name').innerText = s.name;
    node.querySelector('.g-coeff').innerText = s.coeff;
    node.querySelector('.type-badge').innerText = (s.type || 'ex').toUpperCase();
    const inputsDiv = node.querySelector('.inputs');

    // EX input
    const exInput = document.createElement('input');
    exInput.type = 'number'; exInput.placeholder = 'EX'; exInput.step = '0.01';
    exInput.style.width = '120px';
    exInput.className = 'inp-ex';
    inputsDiv.appendChild(exInput);

    if (s.type === 'both' || s.type === 'all') {
      const tdInput = document.createElement('input');
      tdInput.type = 'number'; tdInput.placeholder = 'TD'; tdInput.step = '0.01'; tdInput.className = 'inp-td'; inputsDiv.appendChild(tdInput);
    }
    if (s.type === 'all') {
      const tpInput = document.createElement('input');
      tpInput.type = 'number'; tpInput.placeholder = 'TP'; tpInput.step = '0.01'; tpInput.className = 'inp-tp'; inputsDiv.appendChild(tpInput);
    }

    // تحديث عرض المعدل تلقائياً عند تغيير المدخلات (debounced خفيف)
    const updateAvg = () => {
      const ex = parseFloat(node.querySelector('.inp-ex').value) || 0;
      let avg = ex;
      if (s.type === 'both') {
        const td = parseFloat(node.querySelector('.inp-td').value) || 0;
        avg = ex * s.ratio + td * (1 - s.ratio);
      } else if (s.type === 'all') {
        const td = parseFloat(node.querySelector('.inp-td').value) || 0;
        const tp = parseFloat(node.querySelector('.inp-tp').value) || 0;
        const combo = (td + tp) / 2;
        avg = ex * s.ratio + combo * (1 - s.ratio);
      }
      node.querySelector('.g-avg').innerText = avg.toFixed(2);
    };
    node.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => { updateAvg(); }));

    frag.appendChild(node);
  });

  document.getElementById('grades-container').appendChild(frag);
  document.getElementById('grading-area').classList.remove('hidden');
  document.getElementById('table-result').classList.add('hidden');
  document.getElementById('result').classList.add('hidden');
}

/* ===== حساب المعدل وتوليد جدول النتائج ===== */
document.getElementById('calc-btn').addEventListener('click', () => {
  const rows = Array.from(document.querySelectorAll('.grade-row'));
  let totalW = 0, totalC = 0;
  let tableHtml = `<table><thead><tr><th>المادة</th><th>المعدل</th><th>المعامل</th></tr></thead><tbody>`;
  rows.forEach((r, idx) => {
    const name = r.querySelector('.g-name').innerText;
    const coeff = parseFloat(r.querySelector('.g-coeff').innerText) || 1;
    const avg = parseFloat(r.querySelector('.g-avg').innerText) || 0;
    totalW += avg * coeff;
    totalC += coeff;
    tableHtml += `<tr><td>${name}</td><td>${avg.toFixed(2)}</td><td>${coeff}</td></tr>`;
  });
  tableHtml += `</tbody></table>`;
  const finalAvg = totalC>0 ? (totalW/totalC) : 0;
  document.getElementById('result').innerText = `المعدل العام: ${finalAvg.toFixed(3)}`;
  document.getElementById('result').classList.remove('hidden');
  document.getElementById('table-result').innerHTML = tableHtml;
  document.getElementById('table-result').classList.remove('hidden');
});

/* ===== تصدير CSV بسيط ===== */
document.getElementById('export-csv').addEventListener('click', () => {
  const rows = Array.from(document.querySelectorAll('.grade-row'));
  const lines = rows.map(r => {
    const name = r.querySelector('.g-name').innerText;
    const coeff = r.querySelector('.g-coeff').innerText;
    const avg = r.querySelector('.g-avg').innerText;
    return `${name},${coeff},${avg}`;
  });
  const blob = new Blob([lines.join('\\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'grades_export.csv'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

/* ===== تنزيل PDF باستخدام html2pdf ===== */
document.getElementById('download-pdf').addEventListener('click', () => {
  const el = document.getElementById('table-result');
  if (!el.innerHTML.trim()) return alert('لا توجد نتائج للتصدير');
  html2pdf().from(el).set({ margin: 10, filename: 'grades.pdf' }).save();
});

/* ===== تنظيف التخزين ===== */
document.getElementById('clear-config').addEventListener('click', ()=> {
  if (!confirm('مسح الإعدادات المحلية؟')) return;
  localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(CACHE_KEY);
  app = { specName:'', subjects:[] }; renderSubList(); location.reload();
});

/* ===== Retry/initial check handlers ===== */
document.getElementById('retry-btn').addEventListener('click', async () => {
  document.getElementById('check-msg').innerText = 'جارٍ إعادة التحقق...';
  await initCheck();
});

/* ===== تهيئة عند فتح الصفحة: تحقق سريع ثم تحميل واجهة ===== */
async function initCheck() {
  document.getElementById('overlay-check').classList.remove('hidden');
  document.getElementById('main-ui').classList.add('hidden');
  const res = await checkSubscriptionFast();
  if (res && res.isMember) {
    document.getElementById('overlay-check').classList.add('hidden');
    document.getElementById('main-ui').classList.remove('hidden');
    loadConfig();
    document.getElementById('spec-name').value = app.specName || '';
    document.getElementById('setup-area').classList.remove('hidden');
    renderSubList();
  } else {
    document.getElementById('check-msg').innerText = 'يرجى الاشتراك في القناة ثم الضغط تحقق';
    document.getElementById('overlay-check').querySelector('#retry-btn').innerText = 'اشترك ثم تحقق';
    document.getElementById('retry-btn').onclick = () => {
      window.open((res && res.subscribeUrl) ? res.subscribeUrl : 'https://t.me/moh1101off', '_blank');
    };
  }
}

/* ===== بدء التطبيق ===== */
initCheck();

</script>
</body>
            </html>
