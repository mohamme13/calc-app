<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main-color: #2481cc; --bg-color: #f4f7f9; --accent-color: #27ae60; }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { color: var(--main-color); text-align: center; margin-top: 0; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 14px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main-color); box-shadow: 0 0 5px rgba(36, 129, 204, 0.2); }
        .btn { background: var(--main-color); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-pdf { background: var(--accent-color); margin-top: 20px; }
        .btn-reset { background: #e74c3c; margin-top: 10px; font-size: 13px; padding: 8px; }
        .sub-card { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 15px; background: #fdfdfd; }
        .hidden { display: none !important; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .result-table th { background: #f8f9fa; color: var(--main-color); }
        .badge { background: #eee; padding: 4px 8px; border-radius: 5px; font-size: 12px; font-weight: normal; }
    </style>
</head>
<body>

<div class="container" id="main-app">
    <div id="step-1">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ®ØµØµ</h2>
        <div class="input-group">
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ®ØµØµ:</label>
            <input type="text" id="specialization-name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÙˆÙ… ØªÙ‚Ù†ÙŠØ©">
        </div>
        <div class="input-group">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</label>
            <input type="number" id="total-subs" placeholder="ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ØŸ">
        </div>
        <button class="btn" onclick="initSetup()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
    </div>

    <div id="step-2" class="hidden">
        <h2 id="current-sub-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
        <div class="input-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
            <input type="text" id="sub-name" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠØ²ÙŠØ§Ø¡">
        </div>
        <div class="input-group">
            <label>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„:</label>
            <input type="number" id="sub-coeff" value="1" step="0.5">
        </div>
        <div class="input-group">
            <label>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
            <select id="sub-type" onchange="toggleRatio()">
                <option value="ex">Ø¥Ù…ØªØ­Ø§Ù† (EX) ÙÙ‚Ø·</option>
                <option value="both">Ø¥Ù…ØªØ­Ø§Ù† + Ø£Ø¹Ù…Ø§Ù„ Ù…ÙˆØ¬Ù‡Ø© (EX+TD)</option>
            </select>
        </div>
        <div id="ratio-div" class="hidden">
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù…ØªØ­Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹ 0.6 Ù…Ù‚Ø§Ø¨Ù„ 0.4 Ù„Ù„Ù€ TD):</label>
            <input type="number" id="sub-ratio" value="0.6" step="0.1" max="1">
        </div>
        <button class="btn" onclick="saveSubject()">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
    </div>

    <div id="step-3" class="hidden">
        <h2 id="grading-title">Ø±ØµØ¯ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</h2>
        <div id="grading-area"></div>
        <button class="btn" onclick="calculateFinal()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        <button class="btn btn-reset" onclick="resetApp()">ØªØºÙŠÙŠØ± Ø§Ù„ØªØ®ØµØµ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¯ âš™ï¸</button>
    </div>

    <div id="step-4" class="hidden">
        <div id="pdf-content">
            <h2 id="pdf-spec-name" style="margin-bottom: 5px;">ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø§Ø·</h2>
            <p style="text-align: center; font-size: 12px; color: #666;">ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ ØªÙ„ÙŠØ¬Ø±Ø§Ù…</p>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th>
                        <th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                    </tr>
                </thead>
                <tbody id="result-body"></tbody>
            </table>
            <h3 style="text-align: center; margin-top: 25px; color: var(--accent-color);" id="final-avg-display"></h3>
        </div>
        <button class="btn btn-pdf" onclick="downloadPDF()">ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø§Ø· (PDF) ğŸ“¥</button>
        <button class="btn" style="background: #95a5a6;" onclick="backToGrading()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙ‚Ø·</button>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    if (tg.platform === "unknown") {
        document.body.innerHTML = "<div style='padding:40px; text-align:center;'><h3>Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù….</h3></div>";
    }

    let appData = { 
        specName: "",
        total: 0, 
        current: 0, 
        subjects: [] 
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ®ØµØµ Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.onload = function() {
        const saved = localStorage.getItem('saved_calc_config');
        if (saved) {
            appData = JSON.parse(saved);
            renderGrading();
        }
    };

    function toggleRatio() {
        const type = document.getElementById('sub-type').value;
        document.getElementById('ratio-div').classList.toggle('hidden', type === 'ex');
    }

    function initSetup() {
        appData.specName = document.getElementById('specialization-name').value || "ØªØ®ØµØµ ØºÙŠØ± Ù…Ø³Ù…Ù‰";
        appData.total = parseInt(document.getElementById('total-subs').value);
        if(!appData.total || appData.total <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ù…ÙˆØ§Ø¯ ØµØ­ÙŠØ­");
        
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        updateTitle();
    }

    function updateTitle() {
        document.getElementById('current-sub-title').innerText = `Ø§Ù„Ù…Ø§Ø¯Ø© (${appData.current + 1} Ù…Ù† ${appData.total})`;
    }

    function saveSubject() {
        const name = document.getElementById('sub-name').value;
        const coeff = parseFloat(document.getElementById('sub-coeff').value);
        const type = document.getElementById('sub-type').value;
        const ratio = parseFloat(document.getElementById('sub-ratio').value);

        if(!name || isNaN(coeff)) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©");

        appData.subjects.push({ name, coeff, type, ratio });
        appData.current++;

        if(appData.current < appData.total) {
            document.getElementById('sub-name').value = "";
            updateTitle();
        } else {
            // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµØµ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            localStorage.setItem('saved_calc_config', JSON.stringify(appData));
            renderGrading();
        }
    }

    function renderGrading() {
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-4').classList.add('hidden');
        
        const area = document.getElementById('grading-area');
        area.innerHTML = "";
        document.getElementById('grading-title').innerText = `Ø±ØµØ¯ Ø¹Ù„Ø§Ù…Ø§Øª: ${appData.specName}`;
        
        appData.subjects.forEach((sub, i) => {
            let html = `<div class="sub-card"><strong>${sub.name}</strong> <span class="badge">Ù…Ø¹Ø§Ù…Ù„ ${sub.coeff}</span><br><br>`;
            if(sub.type === 'ex') {
                html += `<label>Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¥Ù…ØªØ­Ø§Ù†:</label><input type="number" class="grade-ex" data-idx="${i}" step="0.01" placeholder="00.00">`;
            } else {
                html += `<label>Ø¹Ù„Ø§Ù…Ø© EX (${sub.ratio*100}%):</label><input type="number" class="grade-ex" data-idx="${i}" step="0.01" placeholder="00.00">`;
                html += `<label style="margin-top:8px;">Ø¹Ù„Ø§Ù…Ø© TD (${(1-sub.ratio).toFixed(1)*100}%):</label><input type="number" class="grade-td" data-idx="${i}" step="0.01" placeholder="00.00">`;
            }
            html += `</div>`;
            area.innerHTML += html;
        });
        document.getElementById('step-3').classList.remove('hidden');
    }

    function calculateFinal() {
        const exInputs = document.querySelectorAll('.grade-ex');
        let totalWeighted = 0, totalCoeffs = 0, tableHtml = "";

        for(let i=0; i < appData.subjects.length; i++) {
            let sub = appData.subjects[i];
            let exVal = parseFloat(exInputs[i].value) || 0;
            let avg = 0;

            if(sub.type === 'both') {
                let tdVal = parseFloat(document.querySelector(`.grade-td[data-idx="${i}"]`).value) || 0;
                avg = (exVal * sub.ratio) + (tdVal * (1 - sub.ratio));
            } else {
                avg = exVal;
            }

            totalWeighted += (avg * sub.coeff);
            totalCoeffs += sub.coeff;
            tableHtml += `<tr><td>${sub.name}</td><td>${avg.toFixed(2)}</td><td>${sub.coeff}</td></tr>`;
        }

        document.getElementById('pdf-spec-name').innerText = `ÙƒØ´Ù Ù†Ù‚Ø§Ø·: ${appData.specName}`;
        document.getElementById('result-body').innerHTML = tableHtml;
        document.getElementById('final-avg-display').innerText = `Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…: ${(totalWeighted / totalCoeffs).toFixed(2)}`;
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-4').classList.remove('hidden');
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        html2pdf().from(element).set({
            margin: 15,
            filename: `ÙƒØ´Ù_${appData.specName}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }

    function backToGrading() {
        document.getElementById('step-4').classList.add('hidden');
        document.getElementById('step-3').classList.remove('hidden');
    }

    function resetApp() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.")) {
            localStorage.removeItem('saved_calc_config');
            location.reload();
        }
    }
</script>
</body>
</html>
