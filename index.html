<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>حاسبة المعدل - الإمبراطورية</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --tg-color: #0088cc; --bg-color: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: var(--tg-color); text-align: center; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn { background: var(--tg-color); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-pdf { background: #e74c3c; margin-top: 20px; }
        .sub-card { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #fafafa; }
        #subscription-overlay { position: fixed; top:0; left:0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .result-table th { background: #f8f9fa; }
    </style>
</head>
<body>

<div id="subscription-overlay">
    <h2>⚠️ تنبيه هام</h2>
    <p>يجب عليك الاشتراك في قناة الإمبراطورية الرسمية لاستخدام هذا البوت مجاناً.</p>
    <button class="btn" onclick="window.open('https://t.me/moh1101off', '_blank')">اضغط هنا للاشتراك @moh1101off</button>
    <button class="btn" style="background: #27ae60;" onclick="checkSub()">لقد اشتركت، اذهب للبوت</button>
</div>

<div class="container hidden" id="main-app">
    <div id="step-1">
        <h2>إعداد المواد</h2>
        <div class="input-group">
            <label>كم عدد المواد؟</label>
            <input type="number" id="total-subs" placeholder="مثلاً 7">
        </div>
        <button class="btn" onclick="initSetup()">متابعة</button>
    </div>

    <div id="step-2" class="hidden">
        <h2 id="current-sub-title">إعداد المادة</h2>
        <div class="input-group">
            <label>اسم المادة:</label>
            <input type="text" id="sub-name" placeholder="اسم المادة">
        </div>
        <div class="input-group">
            <label>المعامل:</label>
            <input type="number" id="sub-coeff" value="1">
        </div>
        <div class="input-group">
            <label>نظام التقييم:</label>
            <select id="sub-type" onchange="toggleRatio()">
                <option value="ex">إمتحان (EX) فقط</option>
                <option value="both">إمتحان + أعمال موجهة (EX+TD)</option>
            </select>
        </div>
        <div id="ratio-div" class="hidden">
            <label>نسبة الإمتحان (مثلاً 0.6 للـ 60%):</label>
            <input type="number" id="sub-ratio" value="0.6" step="0.1">
        </div>
        <button class="btn" onclick="saveSubject()">المادة التالية</button>
    </div>

    <div id="step-3" class="hidden">
        <h2>إدخال العلامات</h2>
        <div id="grading-area"></div>
        <button class="btn" onclick="calculateFinal()">حساب المعدل النهائي</button>
    </div>

    <div id="step-4" class="hidden">
        <div id="pdf-content">
            <h2>كشف النقاط النهائي</h2>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>المادة</th>
                        <th>المعدل</th>
                        <th>المعامل</th>
                    </tr>
                </thead>
                <tbody id="result-body"></tbody>
            </table>
            <h3 style="text-align: center; margin-top: 20px;" id="final-avg-display"></h3>
        </div>
        <button class="btn btn-pdf" onclick="downloadPDF()">تحميل كشف النقاط (PDF)</button>
        <button class="btn" style="background: #7f8c8d;" onclick="location.reload()">بدء من جديد</button>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // التأكد من الفتح داخل تليجرام فقط
    if (tg.platform === "unknown") {
        document.body.innerHTML = "<h2 style='padding:20px;'>عذراً، هذا التطبيق يعمل فقط داخل تطبيق تليجرام.</h2>";
    }

    let appData = { total: 0, current: 0, subjects: [] };

    function checkSub() {
        // بما أننا لا نملك باكدند، سنعتمد على تأكيد المستخدم
        document.getElementById('subscription-overlay').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function toggleRatio() {
        const type = document.getElementById('sub-type').value;
        document.getElementById('ratio-div').className = (type === 'both') ? '' : 'hidden';
    }

    function initSetup() {
        appData.total = parseInt(document.getElementById('total-subs').value);
        if(!appData.total) return alert("أدخل عدد المواد");
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        updateTitle();
    }

    function updateTitle() {
        document.getElementById('current-sub-title').innerText = `إعداد المادة (${appData.current + 1} من ${appData.total})`;
    }

    function saveSubject() {
        const name = document.getElementById('sub-name').value;
        const coeff = parseFloat(document.getElementById('sub-coeff').value);
        const type = document.getElementById('sub-type').value;
        const ratio = parseFloat(document.getElementById('sub-ratio').value);

        if(!name || !coeff) return alert("يرجى ملء كافة البيانات");

        appData.subjects.push({ name, coeff, type, ratio });
        appData.current++;

        if(appData.current < appData.total) {
            document.getElementById('sub-name').value = "";
            updateTitle();
        } else {
            document.getElementById('step-2').classList.add('hidden');
            renderGrading();
        }
    }

    function renderGrading() {
        const area = document.getElementById('grading-area');
        appData.subjects.forEach((sub, index) => {
            let html = `<div class="sub-card"><h4>${sub.name}</h4>`;
            if(sub.type === 'ex') {
                html += `<label>علامة الإمتحان:</label><input type="number" class="grade-ex" data-idx="${index}" step="0.01">`;
            } else {
                html += `<label>علامة الإمتحان (EX):</label><input type="number" class="grade-ex" data-idx="${index}" step="0.01">`;
                html += `<label style="margin-top:10px;">علامة الـ (TD):</label><input type="number" class="grade-td" data-idx="${index}" step="0.01">`;
            }
            html += `</div>`;
            area.innerHTML += html;
        });
        document.getElementById('step-3').classList.remove('hidden');
    }

    function calculateFinal() {
        const exInputs = document.querySelectorAll('.grade-ex');
        const tdInputs = document.querySelectorAll('.grade-td');
        let totalWeighted = 0;
        let totalCoeffs = 0;
        let tableHtml = "";

        for(let i=0; i < appData.subjects.length; i++) {
            let sub = appData.subjects[i];
            let exVal = parseFloat(exInputs[i].value) || 0;
            let avg = 0;

            if(sub.type === 'both') {
                let tdVal = parseFloat(document.querySelector(`.grade-td[data-idx="${i}"]`).value) || 0;
                avg = (exVal * sub.ratio) + (tdVal * (1 - sub.ratio));
            } else {
                avg = exVal;
            }

            totalWeighted += (avg * sub.coeff);
            totalCoeffs += sub.coeff;
            tableHtml += `<tr><td>${sub.name}</td><td>${avg.toFixed(2)}</td><td>${sub.coeff}</td></tr>`;
        }

        let finalAvg = totalWeighted / totalCoeffs;
        document.getElementById('result-body').innerHTML = tableHtml;
        document.getElementById('final-avg-display').innerText = `المعدل العام النهائي: ${finalAvg.toFixed(2)}`;
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-4').classList.remove('hidden');
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        const opt = {
            margin: 1,
            filename: 'كشف_نقاط_الامبراطورية.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
