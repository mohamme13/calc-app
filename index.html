<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>حاسبة المعدل — سريع ومحسّن</title>
  <style>
    :root{--main:#2481cc;--bg:#f6f8fb;--accent:#27ae60;--err:#e74c3c}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:16px;display:flex;justify-content:center}
    .card{width:100%;max-width:640px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 12px;color:var(--main);text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-weight:600;margin-bottom:6px;display:block}
    input,select,button{font-size:15px;padding:10px;border-radius:8px;border:1px solid #dcdcdc;outline:none;background:#fff}
    input[type=number]{width:120px}
    .btn{background:var(--main);color:#fff;border:none;cursor:pointer}
    .btn.secondary{background:#7f8c8d}
    .hidden{display:none!important}
    .sub-list{margin-top:14px;display:grid;gap:12px}
    .sub-card{padding:12px;border:1px solid #eef0f4;border-radius:10px;position:relative;background:#fcfeff}
    .badge{position:absolute;left:12px;top:10px;background:#eaf5ff;color:var(--main);padding:4px 8px;border-radius:6px;font-size:12px}
    small{color:#666}
    #result{margin-top:16px;text-align:center;font-weight:700;color:var(--accent)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .file{display:inline-block}
    .loader{width:28px;height:28px;border-radius:50%;border:3px solid #eee;border-top-color:var(--main);animation:rot 1s linear infinite;display:inline-block}
    @keyframes rot{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eef0f4;padding:8px;text-align:center}
    .small{font-size:13px;color:#555}
  </style>
</head>
<body>
  <div class="card" id="app">
    <h1>حاسبة المعدل السريعة</h1>

    <div id="overlay-check" style="text-align:center;margin-bottom:12px">
      <div class="loader" id="loader"></div>
      <div class="small" style="margin-top:8px">جارٍ التحقق من الاشتراك...</div>
      <div class="small" id="check-msg" style="margin-top:8px;color:#b04">إذا استمر التحميل طويلاً، اضغط تحقق مرة أخرى</div>
      <div style="margin-top:8px">
        <button class="btn secondary" id="retry-btn">تحقق مجدداً</button>
      </div>
    </div>

    <div id="main-ui" class="hidden">
      <div class="row" style="align-items:end">
        <div style="flex:1">
          <label>اسم التخصص</label>
          <input id="spec-name" placeholder="مثلاً: هندسة" />
        </div>
        <div>
          <label>عدد المواد</label>
          <input id="total-sub" type="number" min="1" step="1" value="6" />
        </div>
        <div style="min-width:120px">
          <label>&nbsp;</label>
          <button id="start-btn" class="btn">ابدأ</button>
        </div>
      </div>

      <div id="setup-area" class="hidden" style="margin-top:12px">
        <div class="small">اضف/حرر المواد ثم اضغط "توليد واجهة الدرجات"</div>
        <div style="margin-top:10px" class="row">
          <input id="sub-name" placeholder="اسم المادة" style="flex:1" />
          <input id="sub-coeff" type="number" value="1" min="0.25" step="0.25" style="width:120px" />
          <select id="sub-type" style="width:200px">
            <option value="ex">امتحان (EX)</option>
            <option value="both">EX + أعمال موجهة</option>
            <option value="all">EX + TD + TP</option>
          </select>
          <button id="add-sub" class="btn">أضف</button>
        </div>

        <div class="controls" style="margin-top:10px">
          <button id="gen-grading" class="btn">توليد واجهة الدرجات</button>
          <button id="import-csv" class="btn secondary">استيراد CSV</button>
          <input id="file-input" type="file" accept=".csv" class="file hidden" />
          <button id="clear-config" class="btn secondary">مسح التخزين</button>
        </div>

        <div class="sub-list" id="sub-list"></div>
      </div>

      <div id="grading-area" class="hidden">
        <h3 class="small" id="spec-title">التخصص</h3>
        <div id="grades-container"></div>

        <div class="controls" style="margin-top:12px">
          <button id="calc-btn" class="btn">حساب المعدل</button>
          <button id="export-csv" class="btn secondary">تصدير CSV</button>
          <button id="download-pdf" class="btn">تنزيل PDF</button>
        </div>

        <div id="result" class="hidden"></div>

        <div id="table-result" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- template for subject (cloning faster than string concat) -->
  <template id="sub-template">
    <div class="sub-card">
      <span class="badge"></span>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <div class="small name"></div>
        </div>
        <div style="width:110px;text-align:center"><small>معامل</small><div class="coeff"></div></div>
        <div style="width:140px;text-align:center"><small>نوع</small><div class="type"></div></div>
        <div style="width:80px;text-align:center">
          <button class="btn secondary remove-sub">حذف</button>
        </div>
      </div>
    </div>
  </template>

  <!-- template for grade row -->
  <template id="grade-row-template">
    <div class="sub-card grade-row">
      <span class="badge type-badge"></span>
      <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center">
        <div><strong class="g-name"></strong><div class="small">المعامل: <span class="g-coeff"></span></div></div>
        <div class="inputs" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="text-align:center"><div class="small">المعدل</div><div class="g-avg">0.00</div></div>
      </div>
    </div>
  </template>

<script>
/* ======= إعدادات وأداء ======= */
const WORKER_SCRIPT = 'sub-check-worker.js'; // ملف العامل (Web Worker)
const SUB_KEY = 'fast_gpa_config_v1';
let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
let worker;
let app = {
  specName: '',
  subjects: []
};

/* ======= فحص الاشتراك عبر Web Worker ======= */
function startWorkerCheck() {
  try {
    worker = new Worker(WORKER_SCRIPT);
    const userId = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id : null;
    worker.postMessage({ cmd: 'check', userId });
    worker.onmessage = e => {
      const d = e.data;
      if (d.ok) {
        document.getElementById('overlay-check').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        loadSaved();
        // préparer UI
      } else {
        document.getElementById('check-msg').innerText = 'يرجى الاشتراك في القناة لاستخدام التطبيق';
        // نعرض زر الاشتراك (يمكن فتح رابط)
        document.getElementById('overlay-check').querySelector('#retry-btn').innerText = 'اشترك ثم تحقق';
        document.getElementById('retry-btn').onclick = () => {
          window.open(d.subscribeUrl || 'https://t.me/moh1101off','_blank');
        };
      }
    };
  } catch (err) {
    // fallback: تحقق عادي بدون Worker
    fallbackCheck();
  }
}

async function fallbackCheck() {
  // محاولة سريعة بدون worker
  document.getElementById('overlay-check').classList.add('hidden');
  document.getElementById('main-ui').classList.remove('hidden');
  loadSaved();
}

/* ======= حفظ/تحميل بسيط ======= */
function saveConfig() {
  localStorage.setItem(SUB_KEY, JSON.stringify(app));
}
function loadSaved() {
  const raw = localStorage.getItem(SUB_KEY);
  if (raw) {
    try { app = JSON.parse(raw); } catch(e){}
  }
  // إذا كان محفوظًا أظهر الجزء المناسب
  document.getElementById('setup-area').classList.remove('hidden');
  renderSubList();
}

/* ======= عناصر الواجهة: إضافة مادة/قائمة المواد ======= */
const subListEl = document.getElementById('sub-list');
const subTpl = document.getElementById('sub-template');

function renderSubList() {
  subListEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  app.subjects.forEach((s, idx) => {
    const node = subTpl.content.cloneNode(true);
    node.querySelector('.name').innerText = s.name;
    node.querySelector('.coeff').innerText = s.coeff;
    node.querySelector('.type').innerText = (s.type || 'EX').toUpperCase();
    node.querySelector('.badge').innerText = (idx+1);
    const removeBtn = node.querySelector('.remove-sub');
    removeBtn.addEventListener('click', ()=> {
      app.subjects.splice(idx,1);
      saveConfig(); renderSubList();
    });
    frag.appendChild(node);
  });
  subListEl.appendChild(frag);
}

document.getElementById('add-sub').addEventListener('click', () => {
  const name = document.getElementById('sub-name').value.trim();
  const coeff = parseFloat(document.getElementById('sub-coeff').value) || 1;
  const type = document.getElementById('sub-type').value;
  if (!name) return alert('أدخل اسم المادة');
  app.subjects.push({ name, coeff, type, ratio: 0.6 });
  document.getElementById('sub-name').value = '';
  saveConfig(); renderSubList();
});

document.getElementById('start-btn').addEventListener('click', () => {
  const total = parseInt(document.getElementById('total-sub').value) || 0;
  if (total <= 0) return alert('أدخل عدد مواد صحيح');
  document.getElementById('setup-area').classList.remove('hidden');
  // إذا لم يضف المستخدم مواد نملأ افتراضياً بمسميات فارغة لسرعة البدء
  if (app.subjects.length === 0) {
    for (let i=0;i<Math.min(total,20);i++) app.subjects.push({ name: `مادة ${i+1}`, coeff:1, type:'ex', ratio:0.6 });
    saveConfig();
    renderSubList();
  }
});

/* ======= استيراد CSV (بسيط) ======= */
document.getElementById('import-csv').addEventListener('click', ()=> document.getElementById('file-input').click());
document.getElementById('file-input').addEventListener('change', (e) => {
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    parseCSV(ev.target.result);
    saveConfig(); renderSubList();
  };
  reader.readAsText(f,'utf-8');
});
function parseCSV(text) {
  // يتوقع: name,coeff,type
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  app.subjects = [];
  for (const ln of lines) {
    const parts = ln.split(',');
    if (parts.length>=1) {
      const name = parts[0].trim();
      const coeff = parseFloat(parts[1]) || 1;
      const type = (parts[2]||'ex').trim();
      app.subjects.push({ name, coeff, type, ratio:
